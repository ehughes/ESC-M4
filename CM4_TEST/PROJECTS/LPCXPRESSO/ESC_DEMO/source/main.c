

#include "board.h"
#include "fsl_debug_console.h"
#include "fsl_emc.h"
#include "pin_mux.h"
#include <stdio.h>
#include <string.h>
#include <stdbool.h>

#include "eGFX.h"
#include "eGFX_Driver.h"
#include "FONT_5_7_1BPP.h"
#include "pin_mux.h"
#include "fsl_device_registers.h"
#include "fsl_i2c.h"
#include "fsl_i2s.h"
#include "fsl_wm8904.h"
#include "Audio.h"
#include "fsl_iocon.h"
#include "fsl_common.h"
#include "clock_config.h"
#include "fsl_power.h"
#include "fsl_i2c.h"
#include "fsl_ft5406.h"
#include "arm_math.h"
#include "Sprites_16BPP_565.h"



#include "OCR_A_Extended__20px__Bold__SingleBitPerPixelGridFit_1BPP.h"
#include "Consolas__26px__Regular__AntiAliasGridFit_1BPP.h"
#include "Magneto__26px__Regular__AntiAliasGridFit_16BPP_565.h" 

volatile uint32_t NextSampleOut = 0;
volatile uint32_t RequestBuffer = 0;
volatile uint32_t BufferIndex = 0;

#define BUFFER_SIZE	512

volatile float MicBuffer[BUFFER_SIZE];

void DMIC0_IRQHandler()
{
	int16_t NextSampleIn;

	/*
			This is the IRQ handler for the DMIC.   When the DMIC FIFO gets to a
			preprogrammed level,  and interrupt will be generate and we will end up here!
 */

  /*
			there are several possible interrupt source from the DMIC FIFO.
	     Check to see that it was the INT flag
   */
	if(DMIC0->CHANNEL[1].FIFO_STATUS & DMIC_CHANNEL_FIFO_STATUS_INT_MASK)
	{

		DMIC0->CHANNEL[1].FIFO_STATUS |= DMIC_CHANNEL_FIFO_STATUS_INT_MASK;


		NextSampleIn = (int16_t)(DMIC0->CHANNEL[1].FIFO_DATA);


		if(RequestBuffer)
		{
			MicBuffer[BufferIndex] = (float)((NextSampleIn))  /  ((float)(1<<15));
			BufferIndex++;

			if(BufferIndex == BUFFER_SIZE)
			{
				RequestBuffer = 0;
				BufferIndex = 0;
			}
		}
  }
}

arm_rfft_fast_instance_f32 MyFFT;

float	FFT_RawDataOut[BUFFER_SIZE];
float   FFT_PowerSpectrum[BUFFER_SIZE];

const float Hanning[512] = {
0.00000000,0.00003780,0.00015118,0.00034013,0.00060463,0.00094463,0.00136008,0.00185091,0.00241706,0.00305844,0.00377495,0.00456648,0.00543291,0.00637411,0.00738995,0.00848026,
0.00964488,0.01088363,0.01219634,0.01358279,0.01504278,0.01657609,0.01818249,0.01986173,0.02161357,0.02343773,0.02533393,0.02730190,0.02934134,0.03145193,0.03363337,0.03588531,0.03820741,
0.04059934,0.04306072,0.04559118,0.04819034,0.05085781,0.05359319,0.05639605,0.05926599,0.06220255,0.06520531,0.06827379,0.07140755,0.07460611,0.07786898,0.08119567,0.08458568,0.08803850,
0.09155359,0.09513044,0.09876850,0.10246722,0.10622604,0.11004440,0.11392171,0.11785739,0.12185084,0.12590147,0.13000865,0.13417178,0.13839021,0.14266331,0.14699043,0.15137093,0.15580413,
0.16028937,0.16482597,0.16941325,0.17405050,0.17873704,0.18347214,0.18825510,0.19308519,0.19796168,0.20288384,0.20785091,0.21286216,0.21791681,0.22301412,0.22815330,0.23333358,0.23855417,
0.24381429,0.24911315,0.25444993,0.25982384,0.26523406,0.27067978,0.27616016,0.28167438,0.28722162,0.29280102,0.29841175,0.30405295,0.30972378,0.31542338,0.32115088,0.32690542,0.33268613,
0.33849214,0.34432257,0.35017653,0.35605314,0.36195151,0.36787076,0.37380998,0.37976828,0.38574476,0.39173851,0.39774863,0.40377421,0.40981434,0.41586810,0.42193458,0.42801286,0.43410203,
0.44020116,0.44630933,0.45242561,0.45854909,0.46467884,0.47081393,0.47695343,0.48309641,0.48924195,0.49538912,0.50153698,0.50768461,0.51383108,0.51997546,0.52611682,0.53225422,0.53838676,
0.54451349,0.55063349,0.55674583,0.56284960,0.56894386,0.57502770,0.58110020,0.58716043,0.59320749,0.59924046,0.60525842,0.61126047,0.61724569,0.62321320,0.62916207,0.63509142,0.64100034,
0.64688794,0.65275334,0.65859564,0.66441397,0.67020744,0.67597517,0.68171630,0.68742996,0.69311528,0.69877141,0.70439748,0.70999265,0.71555607,0.72108691,0.72658431,0.73204747,0.73747554,
0.74286770,0.74822315,0.75354107,0.75882066,0.76406112,0.76926165,0.77442148,0.77953982,0.78461589,0.78964894,0.79463819,0.79958290,0.80448232,0.80933570,0.81414232,0.81890144,0.82361235,
0.82827433,0.83288668,0.83744870,0.84195971,0.84641902,0.85082595,0.85517984,0.85948004,0.86372588,0.86791674,0.87205197,0.87613095,0.88015307,0.88411771,0.88802428,0.89187219,0.89566085,
0.89938969,0.90305815,0.90666567,0.91021171,0.91369573,0.91711720,0.92047562,0.92377046,0.92700124,0.93016746,0.93326864,0.93630432,0.93927403,0.94217734,0.94501379,0.94778296,0.95048443,
0.95311780,0.95568266,0.95817863,0.96060533,0.96296239,0.96524946,0.96746618,0.96961224,0.97168729,0.97369103,0.97562316,0.97748338,0.97927141,0.98098698,0.98262983,0.98419971,0.98569639,
0.98711964,0.98846925,0.98974500,0.99094671,0.99207420,0.99312729,0.99410583,0.99500966,0.99583866,0.99659269,0.99727165,0.99787542,0.99840392,0.99885707,0.99923480,0.99953706,0.99976379,
0.99991496,0.99999055,0.99999055,0.99991496,0.99976379,0.99953706,0.99923480,0.99885707,0.99840392,0.99787542,0.99727165,0.99659269,0.99583866,0.99500966,0.99410583,0.99312729,0.99207420,
0.99094671,0.98974500,0.98846925,0.98711964,0.98569639,0.98419971,0.98262983,0.98098698,0.97927141,0.97748338,0.97562316,0.97369103,0.97168729,0.96961224,0.96746618,0.96524946,0.96296239,
0.96060533,0.95817863,0.95568266,0.95311780,0.95048443,0.94778296,0.94501379,0.94217734,0.93927403,0.93630432,0.93326864,0.93016746,0.92700124,0.92377046,0.92047562,0.91711720,0.91369573,
0.91021171,0.90666567,0.90305815,0.89938969,0.89566085,0.89187219,0.88802428,0.88411771,0.88015307,0.87613095,0.87205197,0.86791674,0.86372588,0.85948004,0.85517984,0.85082595,0.84641902,
0.84195971,0.83744870,0.83288668,0.82827433,0.82361235,0.81890144,0.81414232,0.80933570,0.80448232,0.79958290,0.79463819,0.78964894,0.78461589,0.77953982,0.77442148,0.76926165,0.76406112,
0.75882066,0.75354107,0.74822315,0.74286770,0.73747554,0.73204747,0.72658431,0.72108691,0.71555607,0.70999265,0.70439748,0.69877141,0.69311528,0.68742996,0.68171630,0.67597517,0.67020744,
0.66441397,0.65859564,0.65275334,0.64688794,0.64100034,0.63509142,0.62916207,0.62321320,0.61724569,0.61126047,0.60525842,0.59924046,0.59320749,0.58716043,0.58110020,0.57502770,0.56894386,
0.56284960,0.55674583,0.55063349,0.54451349,0.53838676,0.53225422,0.52611682,0.51997546,0.51383108,0.50768461,0.50153698,0.49538912,0.48924195,0.48309641,0.47695343,0.47081393,0.46467884,
0.45854909,0.45242561,0.44630933,0.44020116,0.43410203,0.42801286,0.42193458,0.41586810,0.40981434,0.40377421,0.39774863,0.39173851,0.38574476,0.37976828,0.37380998,0.36787076,0.36195151,
0.35605314,0.35017653,0.34432257,0.33849214,0.33268613,0.32690542,0.32115088,0.31542338,0.30972378,0.30405295,0.29841175,0.29280102,0.28722162,0.28167438,0.27616016,0.27067978,0.26523406,
0.25982384,0.25444993,0.24911315,0.24381429,0.23855417,0.23333358,0.22815330,0.22301412,0.21791681,0.21286216,0.20785091,0.20288384,0.19796168,0.19308519,0.18825510,0.18347214,0.17873704,
0.17405050,0.16941325,0.16482597,0.16028937,0.15580413,0.15137093,0.14699043,0.14266331,0.13839021,0.13417178,0.13000865,0.12590147,0.12185084,0.11785739,0.11392171,0.11004440,0.10622604,
0.10246722,0.09876850,0.09513044,0.09155359,0.08803850,0.08458568,0.08119567,0.07786898,0.07460611,0.07140755,0.06827379,0.06520531,0.06220255,0.05926599,0.05639605,0.05359319,0.05085781,
0.04819034,0.04559118,0.04306072,0.04059934,0.03820741,0.03588531,0.03363337,0.03145193,0.02934134,0.02730190,0.02533393,0.02343773,0.02161357,0.01986173,0.01818249,0.01657609,0.01504278,
0.01358279,0.01219634,0.01088363,0.00964488,0.00848026,0.00738995,0.00637411,0.00543291,0.00456648,0.00377495,0.00305844,0.00241706,0.00185091,0.00136008,0.00094463,0.00060463,0.00034013,
0.00015118,0.00003780,0.00000000};


uint32_t Window= 0;

int main(void)
{

		//Some temporary variables for reading the touch screen
  	int32_t x=10,y=10;
		
	 //We are going to make a variable that stores the coordinate of the slider. 
	 //I will initialize the value to somewhere in the middle
  

	
		//some variables for the touch screen driver
    ft5406_handle_t touch_handle;
   
		touch_event_t touch_event;
	
	


  	/* USART0 clock */
    CLOCK_AttachClk(BOARD_DEBUG_UART_CLK_ATTACH);

    /* Initialize the rest */
    BOARD_InitPins();
	
    BOARD_BootClockPLL180M();
  
	BOARD_InitSPIFI_ExternalFlash();

	BOARD_InitSDRAM();

	eGFX_InitDriver();
	 
	Init_DMIC();

	FT5406_Init(&touch_handle,I2C2);

	arm_rfft_fast_init_f32(&MyFFT,BUFFER_SIZE);  //Init a 512 Point FFT

		while(1)
		{
	
			RequestBuffer = 1;

			while(RequestBuffer == 1)
			{

			}

			 if (kStatus_Success == FT5406_GetSingleTouch(&touch_handle, &touch_event, &y, &x))
		       {
		          if (touch_event == kTouch_Down)
		          {
						Window^=1;
		         }
		       }

				 for(int i=0; i<480*272/2;i++)
				 {
					*((uint32_t *)(eGFX_BackBuffer.Data) + i) = 0xFFFFFFFF;
				 }

				 if(Window == 1)
				 {
					 for (int i=0;i<512;i++)
					 {
						 MicBuffer[i] = MicBuffer[i] * Hanning[i];
					 }
				 }

				 for(int i=1;i<eGFX_PHYSICAL_SCREEN_SIZE_X;i++)
						 {


						 	float Point1 = (MicBuffer[i-1]*(eGFX_PHYSICAL_SCREEN_SIZE_Y/2));

						 	float Point2 = (MicBuffer[i]*(eGFX_PHYSICAL_SCREEN_SIZE_Y/2));


						 	eGFX_DrawLine(&eGFX_BackBuffer,
						 					i-1		,		Point1+eGFX_PHYSICAL_SCREEN_SIZE_Y/2,
						 					i+1		  ,   Point2+eGFX_PHYSICAL_SCREEN_SIZE_Y/2,
						 					eGFX_RGB888_TO_RGB565(0,0,0)
											);

						 	eGFX_DrawLine(&eGFX_BackBuffer,
						 					i-1		,		Point1+eGFX_PHYSICAL_SCREEN_SIZE_Y/2 + 1,
						 					i+1			,   Point2+eGFX_PHYSICAL_SCREEN_SIZE_Y/2 + 1,
						 					eGFX_RGB888_TO_RGB565(0,0,0)
						 					);
						 	eGFX_DrawLine(&eGFX_BackBuffer,
						 						i-1		,		Point1+eGFX_PHYSICAL_SCREEN_SIZE_Y/2 - 1,
						 						i+1		  ,		Point2+eGFX_PHYSICAL_SCREEN_SIZE_Y/2 - 1,
						 						eGFX_RGB888_TO_RGB565(0,0,0)
						 						);


						 }


				 if(Window)
				 {
					eGFX_printf_HorizontalCentered_Colored(&eGFX_BackBuffer,
																2,
																&OCR_A_Extended__20px__Bold__SingleBitPerPixelGridFit_1BPP,
																eGFX_RGB888_TO_RGB565(0,0,0),
																"ARM Cortex M4 CMSIS DSP Example [Hanning]");
				 }
				 else
				 {
						eGFX_printf_HorizontalCentered_Colored(&eGFX_BackBuffer,
																				2,
																				&OCR_A_Extended__20px__Bold__SingleBitPerPixelGridFit_1BPP,
																				eGFX_RGB888_TO_RGB565(0,0,0),
																				"ARM Cortex M4 CMSIS DSP Example [Rect]");
				 }

					eGFX_Blit(&eGFX_BackBuffer,
									eGFX_PHYSICAL_SCREEN_SIZE_X/2 - Sprite_16BPP_565_monkey.SizeX/2 + 1,  //x coordinate of where to put the monkey head
									30,																			 //y coordinate of where to put the monkey head
									&Sprite_16BPP_565_monkey);



					  arm_rfft_fast_f32(&MyFFT,
													  (float *)MicBuffer,
															   FFT_RawDataOut,
															   0);

									 arm_cmplx_mag_squared_f32(FFT_RawDataOut,
													  		    FFT_PowerSpectrum,
															    BUFFER_SIZE/2
															);

				for(int i=0;i<eGFX_PHYSICAL_SCREEN_SIZE_X/2;i++)
				{
					eGFX_DrawVline(&eGFX_BackBuffer, eGFX_PHYSICAL_SCREEN_SIZE_Y-2,
							eGFX_PHYSICAL_SCREEN_SIZE_Y - 2 - (FFT_PowerSpectrum[i+10])*2, i*2, eGFX_RGB888_TO_RGB565(255,32,0));
					eGFX_DrawVline(&eGFX_BackBuffer, eGFX_PHYSICAL_SCREEN_SIZE_Y-2,
											eGFX_PHYSICAL_SCREEN_SIZE_Y - 2 - (FFT_PowerSpectrum[i+10])*2, i*2+1, eGFX_RGB888_TO_RGB565(255,32,32));
				}
			

		
			  //The last step is to dump the backbuffer to the screen.
				eGFX_Dump(&eGFX_BackBuffer);
		}
}



